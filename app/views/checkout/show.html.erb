<% provinces_data = Province.all.index_by(&:id).transform_values { |p| { gst: p.gst.to_f, pst: p.pst.to_f, hst: p.hst.to_f } } %>

<div class="container py-5">
  <h2 class="mb-4 font-weight-bold">Checkout</h2>

  <div class="row">
    <!-- ORDER SUMMARY -->
    <div class="col-lg-5 mb-4">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-0 font-weight-bold">Order Summary</h5>
        </div>

        <ul class="list-group list-group-flush">
          <% @products.each do |product| %>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong><%= product.name %></strong><br>
                <small class="text-muted">Qty: <%= @cart[product.id.to_s] %></small>
              </div>
              <span class="font-weight-bold">
                $<%= number_with_precision(product.price, precision: 2) %>
              </span>
            </li>
          <% end %>

          <li class="list-group-item d-flex justify-content-between">
            <span class="font-weight-bold">Subtotal</span>
            <span class="font-weight-bold">
              $<%= number_with_precision(@subtotal, precision: 2) %>
            </span>
          </li>

          <li class="list-group-item">
            <strong>Taxes</strong>
            <div class="mt-2 ml-2">
              <div class="d-flex justify-content-between">
                <span>GST</span>
                <span>$<span id="gst-amount"><%= number_with_precision(@taxes[:gst], precision: 2) %></span></span>
              </div>
              <div class="d-flex justify-content-between">
                <span>PST</span>
                <span>$<span id="pst-amount"><%= number_with_precision(@taxes[:pst], precision: 2) %></span></span>
              </div>
              <div class="d-flex justify-content-between">
                <span>HST</span>
                <span>$<span id="hst-amount"><%= number_with_precision(@taxes[:hst], precision: 2) %></span></span>
              </div>
            </div>
          </li>

          <li class="list-group-item d-flex justify-content-between bg-light">
            <h5 class="font-weight-bold">Total</h5>
            <h5 class="font-weight-bold text-primary">
              $<span id="total-amount"><%= number_with_precision(@total, precision: 2) %></span>
            </h5>
          </li>
        </ul>
      </div>
    </div>

    <!-- SHIPPING FORM -->
    <div class="col-lg-7">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-0 font-weight-bold">Shipping Address</h5>
        </div>

        <div class="card-body">
          <%= form_with url: checkout_path, method: :post, local: true do |f| %>
            <div class="form-group">
              <label class="font-weight-semibold">Street</label>
              <%= text_field_tag "address[street]", @address.street,
                    class: "form-control form-control-lg", required: true %>
            </div>

            <div class="form-group">
              <label class="font-weight-semibold">City</label>
              <%= text_field_tag "address[city]", @address.city,
                    class: "form-control form-control-lg", required: true %>
            </div>

            <div class="form-group">
              <label class="font-weight-semibold">Postal Code</label>
              <%= text_field_tag "address[postal_code]", @address.postal_code,
                    class: "form-control form-control-lg", required: true %>
            </div>

            <div class="form-group">
              <label class="font-weight-semibold">Province</label>
              <%= select_tag "address[province_id]",
                    options_from_collection_for_select(Province.all, :id, :name, @address.province_id),
                    class: "form-control form-control-lg",
                    id: "address_province_id",
                    data: {
                      provinces: provinces_data.to_json,
                      subtotal: @subtotal.to_f
                    },
                    required: true %>
            </div>

            <%= f.submit "Proceed to Payment", class: "btn btn-primary btn-lg w-100 mt-3" %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function() {
    const select = document.getElementById("address_province_id");
    if (!select) return;

    const gstEl = document.getElementById("gst-amount");
    const pstEl = document.getElementById("pst-amount");
    const hstEl = document.getElementById("hst-amount");
    const totalEl = document.getElementById("total-amount");

    const subtotal = parseFloat(select.dataset.subtotal || "0");
    let provinces = {};

    try {
      provinces = JSON.parse(select.dataset.provinces || "{}");
    } catch (e) {
      provinces = {};
    }

    const formatMoney = (value) => value.toFixed(2);

    function updateTaxes() {
      const province = provinces[select.value];
      if (!province) return;

      const gst = subtotal * (province.gst || 0);
      const pst = subtotal * (province.pst || 0);
      const hst = subtotal * (province.hst || 0);
      const total = subtotal + gst + pst + hst;

      if (gstEl) gstEl.textContent = formatMoney(gst);
      if (pstEl) pstEl.textContent = formatMoney(pst);
      if (hstEl) hstEl.textContent = formatMoney(hst);
      if (totalEl) totalEl.textContent = formatMoney(total);
    }

    select.addEventListener("change", updateTaxes);
    updateTaxes();
  })();
</script>
